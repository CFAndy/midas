# See LICENSE for license details.
#
# Makefrag for generating MIDAS's synthesizable unit tests

# These need to be set by the parent Makefile
#
# rocketchip_dir: Location of rocket chip source -- to grab verilog sources and simulation makefrags
# base_dir:  Main project's top-level, from which we'll launch sbt
# SBT: command to invoke sbt
# generated_dir: Directory into which to emit generate verilog
# sim_dir: Directory in which to build the simulator.

PROJECT ?= midas.unittest
CONFIG ?= AllUnitTests

MAKEFRAG_DIR:=$(shell dirname $(realpath $(lastword $(MAKEFILE_LIST))))

long_name := TestHarness
vsrc := $(rocketchip_dir)/src/main/resources/vsrc
csrc := $(rocketchip_dir)/src/main/resources/csrc

# From Rocket Chip's vsim/Makefile
BACKEND ?= v
TB ?= TestDriver

# Stupidly guess what this test might depend on
src_path = src/main/scala
scala_srcs := $(shell find $(base_dir) -name "*.scala")

include $(rocketchip_dir)/vsim/Makefrag

$(generated_dir)/$(long_name).v $(generated_dir)/$(long_name).behav_srams.v: $(scala_srcs)
	mkdir -p $(@D)
	cd $(base_dir) && $(SBT) "runMain midas.unittest.Generator -td $(generated_dir) "
	touch $(generated_dir)/$(long_name).behav_srams.v

verilog: $(generated_dir)/$(long_name).v

run-midas-unittests: $(simv)
	cd $(sim_dir) && $(exec_simv)

run-midas-unittests-debug: $(simv_debug)
	cd $(sim_dir) && $(exec_simv_debug)

.PHONY: unittests unittests-debug verilog
